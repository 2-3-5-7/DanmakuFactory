## DanmukuFactory

### 获取
[1.30 Lastest Release](release/DanmakuFactory_1.30_release.zip)

~~好累啊，readme就迟点更新叭~~

[使用说明](UserManual_ZH.pdf)

### 概述
~~理想中~~的 danmuku factory 是一款实现各格式类型弹幕文件互转的工具，目前支持xml转ass。本程序文件读与写分开设计，**可以一次读一个或多个弹幕文件**，全部加入到弹幕池当中，然后输出另一个文件，实现弹幕文件在各格式间自由转换...然而前面说的都是设想，当前的转换限于弹幕文件xml转ass。
![pic01](images/01.png)

### 特性

- 支持特殊弹幕！支持特殊弹幕！支持特殊弹幕！
![pic02](images/02.png)
*完美支持b站的特殊弹幕，如图为av810872的效果*

- 强大的调试模式
![pic03](images/03.png)
*在调试模式中，你可以看到屏幕中各类型弹幕的数量，总共屏蔽掉了的数量，没有被屏蔽的弹幕数量以及总弹幕数量，当然还有一个弹幕分布图*

- 超高的转换效率

*在7300HQ关闭调试模式与弹幕屏蔽的情况下，两个样本文件，3千条弹幕总耗时79ms，109万条弹幕总耗时84013ms。当然影响时间的因素很多，以上时间仅作参考*

### 功能
- 支持弹幕文字大小、字体、透明度、阴影、描边的调节
- 支持弹幕时间轴整体偏移、屏幕底部防挡留白
- 支持按类型屏蔽、同屏重复弹幕屏蔽
- 支持控制同屏弹幕的密度，也可以直接让弹幕不重叠
- 支持特殊弹幕的转换
- 调试模式，随字幕显示统计信息以及弹幕分布图
- 更多等你的二次开发

### 命令行说明
1.30以上的版本支持命令行调用
./danmakuFactory [-h][-s][-ip 输入文件名][-if 输入文件格式][-op 输出文件名][-of 输出文件格式][-oe 输出文件编码][-t 时轴偏移][-rx 分辨率宽][-ry 分辨率高][-rt 滚动弹幕滚动时间][-ht 固定弹幕存活时间][-d 弹幕 密度][-fs 文字大小][-fn 字体][-o 不透明度][-l 描边][-sd 阴影][-b 底部留白][-sm 屏蔽模式][-dm 调试模式]

- 选项解释
  -h, --help 显示帮助文本，除非存在其他选项
  -s, --set 将设置保存到文件，没有其他选项则将列出当前文件中的设置值；转换时加入此选项表示将本次设置保存到文件中；如果输入文件名-ip缺省则只修改设置而不进行其他操作

  -ip, --input 输入文件名，除非使用了-s选项，否则缺省将导致出错
  -if, --inputformat 输入文件格式，缺省时程序将自动判断（目前无意义）
  -op, --output 输出文件名，缺省时默认为 "输入文件名.输出文件格式"
  -of, --outputformat 输出文件格式，缺省时默认为ass（目前无意义）
  -oe, --outputencoding 输出文件编码，缺省时将使用配置文件中的值
  -t, --timeshift 时轴偏移量，缺省时默认为0.00

  -rx, --resx 分辨率宽，缺省时将使用配置文件中的值
  -ry, --resy 分辨率高，缺省时将使用配置文件中的值
  -rt, --rolltime 滚动弹幕滚动时间，缺省时将使用配置文件中的值
  -ht, --holdtime 固定弹幕存活时间，缺省时将使用配置文件中的值
  -d, --density 弹幕密度，0 表示无限制，(-1) 表示不重叠，缺省时将使用配置文件中的值
  -fs, --fontsize 文字大小，缺省时将使用配置文件中的值
  -fn, --fontname 字体名称，缺省时将使用配置文件中的值
  -o, --opacity 不透明度，缺省时将使用配置文件中的值
  -l, --outline 描边程度，缺省时将使用配置文件中的值
  -sd, --shadow 阴影程度，缺省时将使用配置文件中的值
  -b, --blank 底部留白，缺省时将使用配置文件中的值
  -sm, --shieldmode 屏蔽模式，缺省时将使用配置文件中的值
  -dm, --debugmode 调试模式，缺省时将使用配置文件中的值

- 注意
  如果参数带有空格请使用双引号，否则将会截断。如："Microsoft YaHei"
  如果参数带有负号请使用括号，否则将解析为选项。如：(-1024.25)

- 举例
  转换test.xml输出默认为D:/test.xml.ass
  danmakuFactory -ip D:/test.xml
  
  转换test.xml输出为D:/test.ass
  danmakuFactory -ip D:/test.xml -op D:/test.ass
  
  转换test.xml输出为D:/test.ass，弹幕密度为不重叠，字体为微软雅黑，不改变配置文件
  danmakuFactory -ip D:/test.xml -op D:/test.ass -d (-1) -fn "Microsoft YaHei"
  
  上一例改变配置文件值
  danmakuFactory -ip D:/test.xml -op D:/test.ass -d (-1) -fn "Microsoft YaHei" -s

### 对源码的详述

#### main.c
主要是简单实现与用户的交互，为调试用，未来可能会考虑做个窗口。

#### DanmakuFactory.h
主要是一些宏定义，数据类型声明，以及除main.c以外几个文件的函数原型声明。

#### ReadFile.c
读入弹幕文件，可在这个文件里写更多格式文件的读入函数，实现多格式支持。

#### WriteFile.c
写出弹幕文件，可以在这个写其他格式文件的写出函数。

#### ListProcessing.c
负责链表处理，链表的排序，链表的释放等。

#### StringProcessing.c
负责字符串的处理，字符串转整型浮点型之类的

该文件下有两个函数暂时没有比较好的解决方案

GetStrHei()函数用于获取弹幕文本的高度，直接用字体大小作为像素值返回

GetStrLen()函数用于获取弹幕文本的宽度，半角字符算半个字，全角字符算一个字，乘字体大小作为像素值返回

两个函数的返回值都是以像素为单位的高或宽，由于不同的字体，不同的字号，文字的像素高宽都有差异，现在暂时没有更好的解决方案，如果您有比较好的解决方案可以提供的话，感激不尽。

### 二次开发
非常欢迎大家的二次开发，当然如果能在您的项目上留下我的名字，我会非常开心的。

### 更新日志

#### 1.00
- 原始版本

#### 1.10
- 结构调整

#### 1.11
- *跟1.20其实是一个版本，不知怎么的当时就傻掉了╮(╯▽╰)╭
- UI微调
- 逻辑优化

#### 1.30
- 大规模修改UI，改善用户体验（炒鸡麻烦的说）
- 解决编码问题，支持ANSI与UTF-8，解决输入中文字体乱码问题
- 增加批量转换
- 增加命令行调用
- 将配置文件存储为文本形式，并支持对旧二进制配置文件的转换

---

### 关于我
我是一个大一的学生，这个程序在我高中的时候用蹩脚的易语言实现过，跟现在的c版比起来唯一的优点就是ui做的挺好的（？，想要的可以邮件联系我，那是我高中时期最有成就感的事情之一啦。上大学之后，我就迫不及待地想要用新学的知识好好地写一个像样的出来，于是就有了这个。由于接触c语言刚刚一个学期，有的函数的实现想了很久，但都是自己一行一行码出来的，算法、代码风格也许比较比较糟糕，希望大家可以见谅，我也会继续努力的。

###### 联系方式
博客 [www.tikm.org](https://www.tikm.org)

邮箱 <hkm@tikm.org>

微信公众号 TIKM
