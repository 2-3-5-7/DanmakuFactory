## DanmukuFactory

### 获取
[1.31 Lastest Release](release/DanmakuFactory_1.31_release.zip)

[使用说明](UserManual_ZH.pdf)

### 概述
DanmakuFactory是一款含弹幕内容文件转换的工具，目前支持xml转ass，未来将会支持更多的格式
![pic01](images/01.png)

### 特性

- 支持特殊弹幕！支持特殊弹幕！支持特殊弹幕！
![pic02](images/02.png)
*完美支持b站的特殊弹幕，如图为av810872的效果*

- 强大的调试模式
![pic03](images/03.png)
*在调试模式中，你可以看到屏幕中各类型弹幕的数量，总共屏蔽掉了的数量，没有被屏蔽的弹幕数量以及总弹幕数量，当然还有一个弹幕分布图*

- 超高的转换效率

*在7300HQ关闭调试模式与弹幕屏蔽的情况下，两个样本文件，3千条弹幕总耗时79ms，109万条弹幕总耗时51064ms。影响时间的因素很多，以上时间仅作参考*

### 功能
- 支持弹幕文字大小、字体、透明度、阴影、描边的调节
- 支持弹幕时间轴整体偏移、屏幕底部防挡留白
- 支持按类型屏蔽、同屏重复弹幕屏蔽
- 支持控制同屏弹幕的密度，也可以直接让弹幕不重叠
- 支持特殊弹幕的转换
- 调试模式，随字幕显示统计信息以及弹幕分布图
- 更多等你的二次开发

### 命令行说明
1.30以上的版本支持命令行调用  
./danmakuFactory [-h][-s][-ip 输入文件名][-if 输入文件格式][-op 输出文件名][-of 输出文件格式][-oe 输出文件编码][-t 时轴偏移][-rx 分辨率宽][-ry 分辨率高][-rt 滚动弹幕滚动时间][-ht 固定弹幕存活时间][-d 弹幕 密度][-fs 文字大小][-fn 字体][-o 不透明度][-l 描边][-sd 阴影][-b 底部留白][-sm 屏蔽模式][-dm 调试模式]  

- 选项解释  
-h,  --help 显示帮助文本，除非存在其他选项  
-s,  --set 将设置保存到文件，没有其他选项则将列出当前文件中的设置值；转换时加入此选项表示将本次设置保存到文件中；如果输入文件名-ip缺省则只修改设置而不进行其他操作  
-ip, --input 输入文件名，除非使用了-s选项，否则缺省将导致出错  
-if, --inputformat 输入文件格式，缺省时程序将自动判断（目前无意义）  
-op, --output 输出文件名，缺省时默认为 "输入文件名.输出文件格式"  
-of, --outputformat 输出文件格式，缺省时默认为ass（目前无意义）  
-oe, --outputencoding 输出文件编码，支持utf-8与ansi，缺省时将使用配置文件中的值  
-t,  --timeshift 时轴偏移量，缺省时默认为0.00  
-rx, --resx 分辨率宽，单位像素，缺省时将使用配置文件中的值  
-ry, --resy 分辨率高，单位像素，缺省时将使用配置文件中的值  
-rt, --rolltime 滚动弹幕滚动时间，单位秒，缺省时将使用配置文件中的值  
-ht, --holdtime 固定弹幕存活时间，单位秒，缺省时将使用配置文件中的值  
-d,  --density 弹幕密度，0 表示无限制，(-1) 表示不重叠，缺省时将使用配置文件中的值  
-fs, --fontsize 文字大小，缺省时将使用配置文件中的值  
-fn, --fontname 字体名称，缺省时将使用配置文件中的值  
-o,  --opacity 不透明度，范围0-255，缺省时将使用配置文件中的值  
-l,  --outline 描边程度，范围0-4，缺省时将使用配置文件中的值  
-sd, --shadow 阴影程度，范围0-4，缺省时将使用配置文件中的值  
-b,  --blank 底部留白，单位像素，缺省时将使用配置文件中的值  
-bm, --blockmode 屏蔽模式，参数由七个0或1组成，分别对应 右左/左右/顶部/底部/特殊/彩色/重复 七类弹幕，0表示不屏蔽，1表示屏蔽，缺省时将使用配置文件中的值  
-dm, --debugmode 调试模式，参数由两个0或1组成，分别对应 数据表格/分布图 两个模块，0表示关闭，1表示开启，缺省时将使用配置文件中的值  
​

- 注意  
  如果参数带有空格请使用双引号，否则将会截断。如："Microsoft YaHei"  
  如果参数带有负号请使用括号，否则将解析为选项。如：(-1024.25)  

- 举例
  转换test.xml输出默认为D:/test.xml.ass  
  danmakuFactory -ip D:/test.xml  
  
  转换test.xml输出为D:/test.ass  
  danmakuFactory -ip D:/test.xml -op D:/test.ass  
  
  转换test.xml输出为D:/test.ass，弹幕密度为不重叠，字体为微软雅黑，不改变配置文件  
  danmakuFactory -ip D:/test.xml -op D:/test.ass -d (-1) -fn "Microsoft YaHei"  
  
  上一例改变配置文件值  
  danmakuFactory -ip D:/test.xml -op D:/test.ass -d (-1) -fn "Microsoft YaHei" -s  

### 二次开发
弹幕文件转换分为三个步骤 读取源文件->弹幕池排序->输出目标文件  
我将三个步骤都单独分开了，为的是让处理更加灵活，例如你可以先多次调用读取函数读取几个文件，再统一排序，最后输出到一个文件，达到合并的效果  
如果要将代码引用到你的项目，请删除以下文件 DanmakuFactory.h 、 main.c 、 ui.c  
下面是一个简单的例子：  

```c

/*
下面示例针对windows平台，非windows平台请删除以下内容 
- 头文件包含windows.h
- 文件StringProcessing.c 下的 函数transcoding
- 文件ListProcessing.c 下的 函数transListCoding
- 文件DanmakuConvert.h 下对 函数transcoding 与 函数transListCoding 的原型声明 
以上删除的功能都是与编码转换相关 
*/ 

#include <stdio.h>
#include <windows.h>
#include "DanmakuConvert.h"
#include "ReadFile.c"
#include "WriteFile.c"
#include "StringProcessing.c"
#include "ListProcessing.c"

int main(void)
{
    DANMAKU *danmakuPoorHead = NULL;/*定义弹幕池的头指针 没东西的时候必须置为NULL 不然操作时会非法访问*/
    
    /*读取文件*/
    readXml("D:\\test.xml",/*要读取的xml文件名*/
            &danmakuPoorHead,/*弹幕池的头指针*/ 
            "n",/*读取方式，"n"清空之前弹幕池的内容并新建 "a"在之前弹幕池的基础上追加*/ 
            0.00/*时轴偏移量*/ 
           );
    /*排序弹幕池*/
    sortList(&danmakuPoorHead);
    /*写出ass文件*/
    writeAss("D:\\test.ass",/*输出文件名*/
             danmakuPoorHead,/*弹幕池的头指针*/
             1920,/*分辨率宽*/
             1080,/*分辨率高*/
             38,/*字号*/
             "Microsoft YaHei",/*字体(与输出文件编码一致的)*/
             1,/*阴影(0-4)*/
             0,/*描边(0-4)*/
             10,/*滚动速度（滚动弹幕）*/
             5,/*停留时间（现隐弹幕）*/ 
             0,/*密度(-1 不重叠 0 无限制 其他正整数代表限制的最大条数)*/
             255,/*不透明度(0-255)*/
             0, /*下部留空*/
             "0000000",
             /*屏蔽 由七个 0 或 1 组成，分别对应 右左/左右/顶部/底部/特殊/彩色/重复 七类弹幕，
             0 表示不屏蔽，1 表示屏蔽*/
             "00"
             /*调试模式 由两个 0 或 1 组成，分别对应 数据表格/分布图 两个模块，
             0 表示关闭，1 表示开启*/
            );
    return 0;
}

```


### 更新日志

#### 1.00
- 原始的一坨可读性爆炸版本

#### 1.10
- 结构调整

#### 1.11
- *跟1.20其实是一个版本，不知怎么的当时就傻掉了╮(╯▽╰)╭
- UI微调
- 逻辑优化

#### 1.30
- 大规模修改UI，改善用户体验（炒鸡麻烦的说）
- 解决编码问题，支持ANSI与UTF-8，解决输入中文字体乱码问题
- 增加批量转换
- 增加命令行调用
- 将配置文件存储为文本形式，并支持对旧二进制配置文件的转换

#### 1.31
- 修复了一些BUG

---

### 关于我
我是一个大一的学生，这个程序在我高中的时候用蹩脚的易语言实现过，跟现在的c版比起来唯一的优点就是ui还行（？，想要的可以邮件联系我，那是我高中时期最有成就感的事情之一啦。上大学之后，我就迫不及待地想要用新学的知识好好地写一个像样的出来，于是就有了这个。由于接触c语言刚刚一个学期，有的函数的实现想了很久，但都是自己一行一行码出来的，算法、代码风格也许比较比较糟糕，希望大家可以见谅，我也会继续努力的。

###### 联系方式
博客 [www.tikm.org](https://www.tikm.org)

邮箱 <hkm@tikm.org>

微信公众号 TIKM
